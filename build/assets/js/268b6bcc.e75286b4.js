"use strict";(self.webpackChunkredback_documentation=self.webpackChunkredback_documentation||[]).push([[1959],{42709:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"cybersecurity/SecDevOps Team/secure-code/TLS_Proof_of_Concept_plus_automation","title":"TLS_Proof_of_Concept_plus_automation","description":"Last updated by \'03/12/2024\'","source":"@site/docs/cybersecurity/SecDevOps Team/secure-code/TLS_Proof_of_Concept_plus_automation.md","sourceDirName":"cybersecurity/SecDevOps Team/secure-code","slug":"/cybersecurity/SecDevOps Team/secure-code/TLS_Proof_of_Concept_plus_automation","permalink":"/redback-documentation/docs/cybersecurity/SecDevOps Team/secure-code/TLS_Proof_of_Concept_plus_automation","draft":false,"unlisted":false,"editUrl":"https://github.com/Redback-Operations/redback-documentation/blob/main/docs/cybersecurity/SecDevOps Team/secure-code/TLS_Proof_of_Concept_plus_automation.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"TLSPlan","permalink":"/redback-documentation/docs/cybersecurity/SecDevOps Team/secure-code/TLSPlan"},"next":{"title":"Dependency-Scanner","permalink":"/redback-documentation/docs/cybersecurity/SecDevOps Team/secure-code/Dependency-Scanner"}}');var r=n(74848),o=n(28453);const i={sidebar_position:2},c="Certbot \u2013 Let's Encrypt TLS solution for Mosquitto MQTT broker",d={},a=[{value:"Proof of Concept",id:"proof-of-concept",level:2},{value:"Retrospective Review",id:"retrospective-review",level:3},{value:"Set Up Test Environment",id:"set-up-test-environment",level:2},{value:"Set Up Test Mosquitto Broker",id:"set-up-test-mosquitto-broker",level:2},{value:"Set Up Certbot and Let\u2019s Encrypt Solution",id:"set-up-certbot-and-lets-encrypt-solution",level:2}];function l(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Last updated by:"})," T_Apperley, ",(0,r.jsx)(t.strong,{children:"Last updated on:"})," '03/12/2024'"]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Last updated by:"})," T_Apperley, ",(0,r.jsx)(t.strong,{children:"Last updated on:"})," '03/12/2024'"]}),"\n",(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"certbot--lets-encrypt-tls-solution-for-mosquitto-mqtt-broker",children:(0,r.jsx)(t.strong,{children:"Certbot \u2013 Let's Encrypt TLS solution for Mosquitto MQTT broker"})})}),"\n",(0,r.jsx)(t.h2,{id:"proof-of-concept",children:"Proof of Concept"}),"\n",(0,r.jsx)(t.h3,{id:"retrospective-review",children:"Retrospective Review"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Version"}),(0,r.jsx)(t.th,{children:"Modified By"}),(0,r.jsx)(t.th,{children:"Date"}),(0,r.jsx)(t.th,{children:"Changes Made"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"v1.0"}),(0,r.jsx)(t.td,{children:"Candice Smith"}),(0,r.jsx)(t.td,{children:"03/09/2024"}),(0,r.jsx)(t.td,{children:"Document Creation draft steps for MQTT Server TLS Implementation"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"v2.0"}),(0,r.jsx)(t.td,{children:"Shalom Ingabo"}),(0,r.jsx)(t.td,{children:"05/09/2024"}),(0,r.jsx)(t.td,{children:"Updated all process steps with confirmed process and added screenshots following technical PoC."})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"v3.0"}),(0,r.jsx)(t.td,{children:"Candice Smith"}),(0,r.jsx)(t.td,{children:"05/09/2024"}),(0,r.jsx)(t.td,{children:"Final formatting of document including division of testing categories, Out of Scope items, etc."})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"v4.0"}),(0,r.jsx)(t.td,{children:"Candice Smith"}),(0,r.jsx)(t.td,{children:"20/09/2024"}),(0,r.jsx)(t.td,{children:"Added Manik\u2019s script"})]})]})]}),"\n",(0,r.jsx)(t.h1,{id:"steps-taken-and-validated-during-poc",children:"Steps taken and validated during PoC"}),"\n",(0,r.jsx)(t.h2,{id:"set-up-test-environment",children:"Set Up Test Environment"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Step 1: Set up EC2 instance"})}),"\n",(0,r.jsx)(t.p,{children:"Created a new security group to allow inbound rules for SSH, HTTPS and MQTT (1883 for secure MQTT and 8883 for non-secure MQTT). Since it was only for test purposes, I allowed access source from any IP address, however, in the case of production, this needs to be hardened through IP address access control to allow only the necessary IP addresses for security purposes."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{src:n(51962).A+"",width:"1381",height:"605"})}),"\n",(0,r.jsx)(t.p,{children:"Launch instance and connect via SSH using command:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"ssh \u2013i /path/to/your-key.pem ubuntu@<EC2-Public-IP>\n"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Step 2: Link your Domain to the instance"})}),"\n",(0,r.jsx)(t.p,{children:"Created a domain using AWS called tlsoluttions.com"}),"\n",(0,r.jsx)(t.p,{children:"We used Route 53 on AWS to create a hosted zone for our domain tlsoluttions.com and did some configurations on the A record to point to our running cloud server instance"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{src:n(50700).A+"",width:"1381",height:"843"})}),"\n",(0,r.jsx)(t.p,{children:"Tested domain link using domainchecker to ensure that our domain was being hosted using the IP address of the running instance (takes about 60 seconds for changes to be applied.)"}),"\n",(0,r.jsx)(t.h2,{id:"set-up-test-mosquitto-broker",children:"Set Up Test Mosquitto Broker"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Step 3: Install mosquitto"})}),"\n",(0,r.jsx)(t.p,{children:"Run the commands:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo apt update\r\nsudo apt install mosquitto mosquitto-clients \n"})}),"\n",(0,r.jsx)(t.p,{children:"in our running instance. This commands updates and install the mosquitto broker to support the MQTT protocol"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Step 4: Configure mosquitto for tls"})}),"\n",(0,r.jsx)(t.p,{children:"Edited the mosquitto configurations file to support secure connections by \trunning the command:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo nano /etc/mosquitto/conf.d/default.conf\n"})}),"\n",(0,r.jsx)(t.p,{children:"Add the following code to enable TLS:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"listener 8883\r\n\r\ncafile /etc/letsencrypt/live/mqttserver.domain.com/chain.pem\r\n\r\ncertfile /etc/letsencrypt/live/mqttserver.domain.com/fullchain.pem\r\n\r\nkeyfile /etc/letsencrypt/live/mqttserver.domain.com/privkey.pem\r\n\r\ntls_version tlsv1.2\n"})}),"\n",(0,r.jsx)(t.p,{children:"Explanation of the above code"}),"\n",(0,r.jsx)(t.p,{children:"listener 8883 specifies the port for TLS connections (default is 8883 for TLS)."}),"\n",(0,r.jsx)(t.p,{children:"cafile points to the CA certificate file (part of the Let's Encrypt chain)."}),"\n",(0,r.jsx)(t.p,{children:"certfile points to your server certificate."}),"\n",(0,r.jsx)(t.p,{children:"keyfile points to your private key."}),"\n",(0,r.jsx)(t.p,{children:"tls_version specifies the minimum TLS version to use."}),"\n",(0,r.jsx)(t.p,{children:"Saved the file then restarted mosquitto using command:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo systemctl restart mosquito\n"})}),"\n",(0,r.jsx)(t.h2,{id:"set-up-certbot-and-lets-encrypt-solution",children:"Set Up Certbot and Let\u2019s Encrypt Solution"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Step 5: Install Certbot for Let\u2019s Encrypt TLS Certificates with Apache"})}),"\n",(0,r.jsx)(t.p,{children:"Install Certbot and Apcahe plugin using command"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"Sudo apt install certbot python3-certbot-apache \u2013y\n"})}),"\n",(0,r.jsx)(t.p,{children:"Obtain SSL Certificates using certbot by running the command:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo certbot \u2013apache \u2013d tlsoluttions.com -d www.tlsoluttions.com \n"})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.img,{src:n(27663).A+"",width:"1381",height:"635"}),"\r\n",(0,r.jsx)(t.img,{src:n(36820).A+"",width:"1381",height:"626"})]}),"\n",(0,r.jsx)(t.p,{children:"[successful certificate generation]"}),"\n",(0,r.jsx)(t.p,{children:"In the above command, certbot uses the Apache plugin to automaticallly configure SSL for our site. Certbot will ask you to choose whether you want to redirect HTTP traffic to HTTPS (which is recommended)"}),"\n",(0,r.jsx)(t.p,{children:"Verify Apache SSL configurations by running the command :"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo nano /etc/apache2/sites-available/000-default-le-ssl.conf\n"})}),"\n",(0,r.jsx)(t.p,{children:"You should be able to see the following lines which tells Apache to use Let\u2019s Encrypt certificates for your domain"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{src:n(69853).A+"",width:"1381",height:"690"})}),"\n",(0,r.jsx)(t.p,{children:"Restart Apache to ensure all changes take effect by running the command:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo systemctl restart apache2\n"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Step 6: Set up automatic renewal"})}),"\n",(0,r.jsx)(t.p,{children:"To force certbot to renew the certificate every day, you can create a cron job that attempts to renew the certificate everyday by running the command:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo crontab -e\n"})}),"\n",(0,r.jsx)(t.p,{children:"Add the following line"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{src:n(11358).A+"",width:"1353",height:"714"})}),"\n",(0,r.jsx)(t.p,{children:"Explanation of the line"}),"\n",(0,r.jsx)(t.p,{children:"30 2 * * *: This schedules the task to run at 2:30 AM everyday"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"/usr/bin/certbot renew \u2013force-renewal\n"})}),"\n",(0,r.jsx)(t.p,{children:"This command forces certbot to renew the certificate, even if it has not reached the typical renewal period which is typically 90 days"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"/var/log/le-renew.log\n"})}),"\n",(0,r.jsx)(t.p,{children:"This appends the output of the command to a log file for review"}),"\n",(0,r.jsx)(t.p,{children:"To check the list of the active timer, run command:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo systemctl list-timers and check for certbot.timer\n"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{src:n(14965).A+"",width:"1381",height:"391"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Step 7: Testing automatic renewal"})}),"\n",(0,r.jsx)(t.p,{children:"Let\u2019s Encrypt certificates are valid for 90 days, but with the installation of certbot, the renewal process is automated and can be tested by running the command:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo certbot renew \u2013dry-run\n"})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.img,{src:n(45868).A+"",width:"602",height:"198"}),"\r\n[successful automated renewal]"]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.img,{src:n(54797).A+"",width:"602",height:"354"}),"\r\n",(0,r.jsx)(t.img,{src:n(73174).A+"",width:"602",height:"396"}),"\r\n[verifying Apache SSL]"]}),"\n",(0,r.jsx)(t.h1,{id:"automation--script",children:"Automation \u2013 Script"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Setup Automation"})}),"\n",(0,r.jsx)(t.p,{children:"To streamline the deployment and configuration process, this is an automated script that sets up Mosquitto, configures TLS, installs Certbot, and manages SSL certificates. Below is the script used for this PoC:"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"The script-"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"#!/bin/bash\r\n\r\nsudo apt-get update\r\n\r\nsudo apt-get install -y mosquitto mosquitto-clients apache2 certbot python3-certbot-apache\r\n\r\nsudo tee /etc/mosquitto/conf.d/mosquitto_tls.conf > /dev/null <<EOF\r\n\r\nlistener 8883\r\n\r\ncafile /etc/letsencrypt/live/YOUR_DOMAIN/fullchain.pem\r\n\r\ncertfile /etc/letsencrypt/live/YOUR_DOMAIN/cert.pem\r\n\r\nkeyfile /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem\r\n\r\ntls_version tlsv1.2\r\n\r\nEOF\r\n\r\nsudo a2enmod proxy proxy_http proxy_wstunnel ssl\r\n\r\nsudo tee /etc/apache2/sites-available/000-default.conf > /dev/null <<EOF\r\n\r\n<VirtualHost *:80>\r\n\r\nServerName YOUR_DOMAIN\r\n\r\nProxyPass /mqtt ws://localhost:1883/\r\n\r\nProxyPassReverse /mqtt ws://localhost:1883/\r\n\r\nProxyPass /mqttssl wss://localhost:8883/\r\n\r\nProxyPassReverse /mqttssl wss://localhost:8883/\r\n\r\nErrorLog \\${APACHE_LOG_DIR}/error.log\r\n\r\nCustomLog \\${APACHE_LOG_DIR}/access.log combined\r\n\r\n</VirtualHost>\r\n\r\nEOF\r\n\r\nsudo systemctl restart apache2\r\n\r\nsudo certbot --apache -d YOUR_DOMAIN\r\n\r\nsudo mkdir -p /etc/mosquitto/certs\r\n\r\nsudo cp /etc/letsencrypt/live/YOUR_DOMAIN/fullchain.pem /etc/mosquitto/certs/fullchain.pem\r\n\r\nsudo cp /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem /etc/mosquitto/certs/privkey.pem\r\n\r\necho \"0 3 * * * certbot renew --post-hook 'systemctl restart apache2 && systemctl restart mosquitto'\" | sudo tee -a /var/spool/cron/crontabs/root\n"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Steps to use the script"})}),"\n",(0,r.jsx)(t.p,{children:"Create a new file for the script:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"nano new_file.sh\n"})}),"\n",(0,r.jsx)(t.p,{children:"Paste the automated script into the file. Make sure to replace YOUR_DOMAIN with your actual domain name"}),"\n",(0,r.jsx)(t.p,{children:"Change the script\u2019s permissions to make it executable:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo chmod +x new_file.sh\n"})}),"\n",(0,r.jsx)(t.p,{children:"Execute the script to perform the setup:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo ./new_file.sh\n"})}),"\n",(0,r.jsx)(t.h1,{id:"out-of-scope",children:"Out of Scope"}),"\n",(0,r.jsx)(t.p,{children:"Additional steps and information that may be useful during implementation, deemed out of scope for PoC activity."}),"\n",(0,r.jsx)(t.p,{children:"Alternative Certbot installation methods for various OS\u2019s can be found here: \xa0"}),"\n",(0,r.jsx)(t.p,{children:"Verify config by testing with MQTT Clients"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"mosquitto_sub -h mqttserver.domain.com -p 8883 -t test/topic \\--cafile\r\n\r\n/etc/letsencrypt/live/mqttserver.domain.com/chain.pem\n"})}),"\n",(0,r.jsx)(t.p,{children:"*You may need to adjust the port -- please review"}),"\n",(0,r.jsx)(t.p,{children:"In the case a client fails to connect, check Mosquitto logs for errors."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo journalctl -u mosquito\n"})}),"\n",(0,r.jsx)(t.p,{children:"Reload Mosquitto config after successful renewal:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo nano /etc/letsencrypt/renewal-hooks/post/reload-mosquitto.sh\r\n#!/bin/bash\r\nsystemctl reload mosquitto\r\nsudo chmod +x /etc/letsencrypt/renewal-hooks/post/reload-mosquitto.sh\n"})}),"\n",(0,r.jsx)(t.h1,{id:"proof-of-concept-outcome",children:"Proof of Concept Outcome"}),"\n",(0,r.jsx)(t.p,{children:"The outcome of this PoC has been to validate the process for the successful deployment of Certbot and Let\u2019s Encrypt to secure a Mosquitto MQTT broker stored on a server utilising Apache as the operating system."}),"\n",(0,r.jsx)(t.p,{children:"Not only does this provide a validated process for future TLS deployments but also provides a guide to creating a testing environment for any future proof of concept requirements resulting in a much more efficient process and more focus on testing the new technologies rather than the testing environment."}),"\n",(0,r.jsx)(t.p,{children:"This PoC has resulted in the successful testing of the Certbot \u2013 Let's Encrypt TLS solution as applied to our test MQTT broker, with the successful renewal of the deployed certificate. All this is also captured in an easy to run script which will deploy a Mosquitto broker with TLS."})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},51962:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/TLS_PoC_Launchinst-9642a21525c90402923f019fed640f83.png"},50700:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/TLS_PoC_Route53-b6c95534ea75686de81a5626d0fcc610.png"},11358:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/TLS_PoC_Terminal1-3a29b5e6d112c597b2d285c88f9da84f.png"},27663:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/TLS_PoC_codeexample1-2320e7ca6d2bdeb3a1498f1bf0f52f64.png"},36820:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/TLS_PoC_codeexample2-77e344e2abe29554d6f5428d906e3126.png"},69853:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/TLS_PoC_codeexample3-7685b107437371610f1cf82a1fe06b1e.png"},14965:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/TLS_Poc_Terminal2-4980e99d7e1e09de07b50920894768b0.png"},45868:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/TLS_Poc_Terminal3-373174e30b1d59ed58f1a1d2436050d2.png"},54797:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/TLS_Poc_Ubuntu1-e42560d72e10d70e44ab91b87103f9c4.png"},73174:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/TLS_Poc_Ubuntu2-025c619094c359e92d0b849fd31ef22f.png"},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>c});var s=n(96540);const r={},o=s.createContext(r);function i(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);